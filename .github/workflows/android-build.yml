name: Build Android Release APK

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --max-old-space-size=4096
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK (emulator-runner installs SDK tooling)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          target: default
          arch: x86_64

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install
        working-directory: ./

      - name: Ensure Capacitor CLI
        run: pnpm exec -y @capacitor/cli --version

      - name: Add Android platform
        run: pnpm exec -y @capacitor/cli add android || true

      - name: Sync Capacitor
        run: pnpm exec -y @capacitor/cli sync android

      - name: Build Android (assembleRelease)
        run: |
          cd android
          ./gradlew assembleRelease --no-daemon -x lint

      - name: Generate keystore if none provided
        if: ${{ !secrets.RELEASE_KEYSTORE_BASE64 }}
        run: |
          set -euo pipefail
          mkdir -p android/app
          KEY_ALIAS=hrmchat
          # generate a random password
          KEY_PASS=$(openssl rand -base64 12 | tr -dc 'A-Za-z0-9' | cut -c1-16)
          echo "Generating keystore with alias=$KEY_ALIAS"
          keytool -genkeypair -v -keystore android/app/release-keystore.jks -storepass "$KEY_PASS" -keypass "$KEY_PASS" -alias "$KEY_ALIAS" -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=HRM Chat, OU=Dev, O=Company, L=City, S=State, C=US"
          echo "$KEY_PASS" > android/app/release-keystore-password.txt
          echo "$KEY_ALIAS" > android/app/release-keystore-alias.txt

      - name: Prepare keystore (from secret)
        if: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
        run: |
          echo "$RELEASE_KEYSTORE_BASE64" | base64 --decode > android/app/release-keystore.jks
        env:
          RELEASE_KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}

      - name: Sign APK (use provided or generated keystore)
        run: |
          unsigned=$(find android/app/build/outputs -type f -name "*release-unsigned*.apk" | head -n1)
          if [ -z "$unsigned" ]; then echo "Unsigned APK not found"; exit 1; fi
          ls -la "$unsigned"
          # Find apksigner
          apksigner="$(find "$ANDROID_SDK_ROOT" -path "*/build-tools/*/apksigner" | sort | tail -n1)"
          if [ -z "$apksigner" ]; then apksigner="$(find "$ANDROID_HOME" -path "*/build-tools/*/apksigner" | sort | tail -n1)"; fi
          if [ -z "$apksigner" ]; then echo "apksigner not found"; exit 1; fi

          # Determine keystore credentials
          if [ -f android/app/release-keystore-password.txt ]; then
            KS_PASS=$(cat android/app/release-keystore-password.txt)
            KS_ALIAS=$(cat android/app/release-keystore-alias.txt || echo hrmchat)
          else
            KS_PASS="$RELEASE_KEYSTORE_PASSWORD"
            KS_ALIAS="$RELEASE_KEY_ALIAS"
          fi

          out=android/app/build/outputs/apk/release/app-release-signed.apk
          "$apksigner" sign --ks android/app/release-keystore.jks --ks-key-alias "$KS_ALIAS" --ks-pass pass:"$KS_PASS" --out "$out" "$unsigned"
          echo "Signed APK: $out"
        env:
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          RELEASE_KEYSTORE_PASSWORD: ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}

      - name: Upload keystore (if generated)
        if: ${{ !secrets.RELEASE_KEYSTORE_BASE64 }}
        uses: actions/upload-artifact@v4
        with:
          name: release-keystore
          path: |
            android/app/release-keystore.jks
            android/app/release-keystore-password.txt
            android/app/release-keystore-alias.txt

      - name: Upload artifact (signed or unsigned)
        uses: actions/upload-artifact@v4
        with:
          name: hrmchat-android-apk
          path: |
            android/app/build/outputs/apk/release/app-release-signed.apk
            android/app/build/outputs/apk/release/*release-unsigned*.apk
